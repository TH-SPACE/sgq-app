const ActiveDirectory = require("activedirectory");
const dotenv = require("dotenv");
 
const config = {
  //url: process.env.URL_LDAP,
  url: 'ldap://redecorp.br',
  baseDN: "dc=redecorp, dc=com",
};
 
const activeDirectory = new ActiveDirectory(config);
 
const ad = {
  authenticate: (username, password) => {
    return new Promise((resolve, reject) => {
      activeDirectory.authenticate(username, password, (err, auth) => {
        if (err) {
          reject(err);
        }
        if (auth) {
          resolve(auth);
        } else {
          reject(false);
        }
      });
    });
  },
};

module.exports = ad;


// Consumo:
 
await ad.authenticate(domain.toUpperCase() + "\\" + login, pwd,
  function (err, auth) {
    if (auth) {
      const token = jwt.sign({ id_usr },
        secretJwt.secret, {
        expiresIn: secretJwt.expiresIn
      }
      )
 
      return res.status(200).json({
        message: "Authenticated!",
        auth: true,
        id_usr: id_usr,
        apelido: apelido,
        token: token
      });
    }
    else {
      console.log(err);
      return res.status(401).send({
        message: "Authentication failed! " + err, auth: false
      });
    }
  });