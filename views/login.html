<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login SGQ</title>
    <link rel="icon" type="image/png" href="/img/b2b.png">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="d-flex align-items-start justify-content-center vh-100 bg-light">

    <div class="card shadow p-4 mt-5" style="width: 350px;">
        <div class="d-flex align-items-center mb-4">
            <img src="/img/account.png" class="me-2" height="72" width="72">
            <h3 class="mb-0 fw-bold" style="color: #483D8B;">Entrar</h3>
        </div>

        <div id="alertaSenhaAlterada" class="alert alert-success alert-dismissible fade show mt-1" role="alert"
            style="display: none;">
            Senha redefinida com sucesso. Fa√ßa login!!
        </div>

        <div id="alertaErroEmail" class="alert alert-danger alert-dismissible fade show mt-1" role="alert"
            style="display: none;">
            Email inv√°lido!!
        </div>
        <div id="alertaErro" class="alert alert-danger alert-dismissible fade show mt-1" role="alert"
            style="display: none; align-items: center; text-align: center;">
            Usu√°rio ou senha inv√°lidos.
        </div>
        <div id="alertaErro2" class="alert alert-warning alert-dismissible fade show mt-3" role="alert"
            style="display: none;">
            Sua conta ainda n√£o foi aprovada pelo administrador.
        </div>

        <!--AQUI √â O FORM DO LOGIN E FOI MODIFICADO PARA NAME="login" e NAME="pwd" -->
        <form action="/auth/login" method="POST">
            <div class="mb-3">
                <label for="email" class="form-label fw-medium">Email</label>
                <input type="email" name="email" class="form-control" id="email" placeholder="Digite seu email"
                    required>
            </div>
            <div class="mb-3">
                <label for="password" class="form-label fw-medium">Senha</label>
                <input type="password" name="senha" class="form-control" id="password" placeholder="Digite sua senha"
                    required>
            </div>
            <button type="submit" class="btn btn-primary w-100 btn-lg">Entrar</button>
        </form>

        <!--
        REMOVIDO A PARTE DE CADASTRO!!

        <p class="text-center mt-3">
            <small>N√£o tem uma conta? <a href="/auth/cadastro">Cadastre-se</a></small>
            <small>N√£o tem uma conta? <a href="#" onclick="abrirCadastro()">Cadastre-se</a></small>

        </p>

         
        REMOVIDO A PARTE DE  ESQUECEU A SENHA!!
        <div class="text-center mt-3">
            <a href="#" onclick="esqueciSenha()">Esqueceu sua senha?</a>
        </div>
    </div>-->

        <script>
            const textoNaUrl = new URLSearchParams(window.location.search);
            if (textoNaUrl.get("erro") === "1") {
                document.getElementById("alertaErro").style.display = "block";
            }
            if (textoNaUrl.get("erro") === "2") {
                document.getElementById("alertaErro2").style.display = "block";
            }
            if (textoNaUrl.get("erro") === "email_nao_encontrado") {
                document.getElementById("alertaErroEmail").style.display = "block";
            }
            if (textoNaUrl.get("sucesso") === "senha_alterada") {
                document.getElementById("alertaSenhaAlterada").style.display = "block";
            }

            async function esqueciSenha() {
                const { value: email } = await Swal.fire({
                    title: "Recuperar Senha",
                    text: "Digite seu e-mail corporativo:",
                    input: "email",
                    inputLabel: "Seu e-mail",
                    inputPlaceholder: "ex: voce@telefonica.com",
                    confirmButtonText: "Verificar",
                    cancelButtonText: "Cancelar",
                    showCancelButton: true,
                    position: "top",
                    inputValidator: (value) => {
                        if (!value) return "Voc√™ precisa digitar um e-mail!";
                        if (!value.endsWith("@telefonica.com"))
                            return "Apenas e-mails @telefonica.com s√£o aceitos.";
                    }
                });

                if (!email) return;

                // üîç Busca pergunta secreta do usu√°rio
                const res = await fetch("/auth/pergunta?email=" + encodeURIComponent(email));
                const data = await res.json();

                if (!res.ok) {
                    return Swal.fire({
                        icon: 'error',
                        title: 'Erro',
                        text: data.erro || 'Usu√°rio n√£o encontrado.',
                        position: 'top', // üëà Aparece no topo
                        showConfirmButton: true
                    });
                }

                // üëâ Mostrar pergunta e campo para resposta
                const { value: resposta } = await Swal.fire({
                    title: "Confirma√ß√£o de identidade",
                    html: `
      <p><strong>${data.pergunta}</strong></p>
      <input id="respostaInput" class="swal2-input" placeholder="Sua resposta secreta" autocomplete="off">
    `,
                    preConfirm: () => {
                        const r = document.getElementById("respostaInput").value.trim();
                        if (!r) return Swal.showValidationMessage("Digite a resposta.");
                        return r;
                    },
                    showCancelButton: true,
                    confirmButtonText: "Confirmar",
                    position: "top",
                    cancelButtonText: "Cancelar"
                });

                if (!resposta) return;

                // üëâ Verifica resposta
                const res2 = await fetch("/auth/verifica-resposta", {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: new URLSearchParams({ email, resposta })
                });

                if (!res2.ok) {
                    return Swal.fire({
                        icon: 'error',
                        title: 'Erro',
                        text: data.erro || 'Resposta Incorreta!!',
                        position: 'top', // üëà Aparece no topo
                        showConfirmButton: true
                    });
                }

                // ‚úÖ Permite redefinir a senha
                const { value: novaSenha } = await Swal.fire({
                    title: "Redefinir Senha",
                    html: `
      <input id="novaSenha" type="password" class="swal2-input" placeholder="Nova senha">
      <input id="confirmarSenha" type="password" class="swal2-input" placeholder="Confirme a nova senha">
    `,
                    preConfirm: () => {
                        const senha1 = document.getElementById("novaSenha").value;
                        const senha2 = document.getElementById("confirmarSenha").value;
                        if (!senha1 || !senha2) return Swal.showValidationMessage("Preencha todos os campos.");
                        if (senha1.length < 6) return Swal.showValidationMessage("A senha deve ter pelo menos 6 caracteres.");
                        if (senha1 !== senha2) return Swal.showValidationMessage("As senhas n√£o coincidem.");
                        return senha1;
                    },
                    showCancelButton: true,
                    confirmButtonText: "Salvar",
                    position: "top",
                    cancelButtonText: "Cancelar"
                });

                if (!novaSenha) return;

                // üì® Envia nova senha para salvar
                const res3 = await fetch("/auth/resetar-senha", {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: new URLSearchParams({ email, senha: novaSenha })
                });

                if (res3.ok) {
                    Swal.fire({
                        icon: "success",
                        title: "Sucesso",
                        text: "Senha redefinida com sucesso!",
                        position: "top",         // üëà Aparece no topo da tela
                        showConfirmButton: true  // ou false se quiser fechar sozinho
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Erro',
                        text: data.erro || 'Erro ao atualizar a senha!!',
                        position: 'top', // üëà Aparece no topo
                        showConfirmButton: true
                    });
                }
            }


            // Fun√ß√£o principal chamada ao clicar em "Cadastre-se"
            async function abrirCadastro() {
                const { value: formValues } = await Swal.fire({
                    title: 'Cadastro',
                    html: `
  <form id="form-cadastro">
    <div class="form-group row">
      <label for="swal-nome" class="col-sm-4 col-form-label text-right fw-bold">Nome completo:</label>
      <div class="col-sm-8">
        <input id="swal-nome" type="text" class="form-control" placeholder="Digite seu nome completo">
      </div>
    </div>

    <div class="form-group row mt-2">
      <label for="swal-email" class="col-sm-4 col-form-label text-right fw-bold">E-mail corporativo:</label>
      <div class="col-sm-8">
        <input id="swal-email" type="email" class="form-control" placeholder="ex: colaborador@telefonica.com" autocomplete="off" readonly onfocus="this.removeAttribute('readonly')">
      </div>
    </div>

    <div class="form-group row mt-2">
      <label for="swal-senha" class="col-sm-4 col-form-label text-right fw-bold">Senha:</label>
      <div class="col-sm-8">
        <input id="swal-senha" type="password" class="form-control" placeholder="Crie uma senha segura" autocomplete="off" readonly onfocus="this.removeAttribute('readonly')"> 
      </div>
    </div>

    <div class="form-group row mt-2">
      <label for="swal-confirmar" class="col-sm-4 col-form-label text-right fw-bold">Confirmar senha:</label>
      <div class="col-sm-8">
        <input id="swal-confirmar" type="password" class="form-control" placeholder="Repita a senha">
      </div>
    </div>

    <div class="form-group row mt-2">
      <label for="swal-pergunta" class="col-sm-4 col-form-label text-right fw-bold">Pergunta secreta:</label>
      <div class="col-sm-8 ">
        <select id="swal-pergunta" class="form-control">
          <option value="">Escolha uma pergunta...</option>
          <option value="pet">Qual o nome do seu primeiro pet?</option>
          <option value="mae">Qual o nome da sua m√£e?</option>
          <option value="cidade">Em que cidade voc√™ nasceu?</option>
        </select>
      </div>
    </div>

    <div class="form-group row mt-2">
      <label for="swal-resposta" class="col-sm-4 col-form-label text-right fw-bold">**Resposta secreta</label>
      <div class="col-sm-8">
        <input id="swal-resposta" type="text" class="form-control" placeholder="Sua resposta secreta">
      </div>
    </div>

    <div class="form-group row mt-2">
      <div class="col-sm-12 text-center">
        <small class="text-muted">
          **A pergunta secreta ser√° usada caso voc√™ precise redefinir sua senha futuramente.
        </small>
      </div>
    </div>
  </form>
`,
                    width: '650px',


                    focusConfirm: false,
                    showCancelButton: true,
                    cancelButtonText: 'Cancelar',
                    confirmButtonText: 'Cadastrar',
                    position: 'top',

                    preConfirm: () => {
                        const nome = document.getElementById('swal-nome').value.trim();
                        const email = document.getElementById('swal-email').value.trim();
                        const senha = document.getElementById('swal-senha').value;
                        const confirmar = document.getElementById('swal-confirmar').value;
                        const pergunta = document.getElementById('swal-pergunta').value;
                        const resposta = document.getElementById('swal-resposta').value.trim();

                        if (!nome || !email || !senha || !confirmar || !pergunta || !resposta)
                            return Swal.showValidationMessage('Todos os campos s√£o obrigat√≥rios.');

                        if (!email.endsWith('@telefonica.com'))
                            return Swal.showValidationMessage('Somente e-mails @telefonica.com s√£o permitidos.');

                        if (senha.length < 6)
                            return Swal.showValidationMessage('A senha deve ter pelo menos 6 caracteres.');

                        if (senha !== confirmar)
                            return Swal.showValidationMessage('As senhas n√£o coincidem.');

                        return {
                            nome,
                            email,
                            senha,
                            pergunta_secreta: pergunta,
                            resposta_secreta: resposta,
                            status: 'AGUARDANDO'
                        };
                    }
                });

                if (formValues) {
                    Swal.fire({
                        title: 'Cadastrando...',
                        text: 'Por favor, aguarde',
                        allowOutsideClick: false,
                        didOpen: () => Swal.showLoading()
                    });

                    fetch('/auth/cadastro', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: new URLSearchParams(formValues)
                    })
                        .then(res => {
                            if (res.ok) {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Cadastro realizado!',
                                    text: 'Usu√°rio cadastrado com sucesso. Aguarde aprova√ß√£o.'
                                });
                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Erro',
                                    text: 'N√£o foi poss√≠vel cadastrar o usu√°rio.'
                                });
                            }
                        })
                        .catch(() => {
                            Swal.fire({
                                icon: 'error',
                                title: 'Erro de rede',
                                text: 'Falha ao conectar ao servidor. Tente novamente mais tarde.'
                            });
                        });
                }
            }


        </script>




        <script src="/js/sweetalert2.all.min.js"></script>

        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>