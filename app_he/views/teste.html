<div class="container mt-5 pt-4">
    <div class="card shadow">
        <div class="card-body">
            <h3 class="text-center mb-4">
                <i class="fa-solid fa-paper-plane text-primary"></i>
                Enviar Solicitação de Horas Extras
            </h3>

            <form id="formHE">
                <div class="form-group">
                    <label for="gerente">Gerente</label>
                    <select id="gerente" name="gerente" class="form-control select2" required>
                        <option value="">Selecione a Gerencia</option>
                    </select>

                </div>

                <div class=" form-group">
                    <label for="colaborador">Colaborador</label>
                    <select id="colaborador" name="colaborador" class="form-control" required>
                        <option value="">Selecione o Colaborador</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="matricula">Matrícula</label>
                    <input type="text" id="matricula" name="matricula" class="form-control" readonly />
                </div>

                <div class="form-group">
                    <label for="cargo">Cargo</label>
                    <input type="text" id="cargo" name="cargo" class="form-control" readonly />
                </div>

                <div class="form-group">
                    <label for="mes">Mês</label>
                    <select id="mes" name="mes" class="form-control" required>
                        <option value="Janeiro">Janeiro</option>
                        <option value="Fevereiro">Fevereiro</option>
                        <option value="Março">Março</option>
                        <option value="Abril">Abril</option>
                        <option value="Maio">Maio</option>
                        <option value="Junho">Junho</option>
                        <option value="Julho">Julho</option>
                        <option value="Agosto">Agosto</option>
                        <option value="Setembro">Setembro</option>
                        <option value="Outubro">Outubro</option>
                        <option value="Novembro">Novembro</option>
                        <option value="Dezembro">Dezembro</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="horas">Quantidade de Horas</label>
                    <input type="number" id="horas" name="horas" class="form-control" min="1" step="0.5" required />
                </div>

                <div class="form-group">
                    <label for="justificativa">Justificativa</label>
                    <select id="justificativa" name="justificativa" class="form-control" required>
                        <option value="">Selecione</option>
                        <option value="Atendimento fora do horário">Atendimento fora do horário</option>
                        <option value="Demanda emergencial">Demanda emergencial</option>
                        <option value="Cobertura de ausência">Cobertura de ausência</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="tipoHE">Tipo de HE</label>
                    <select id="tipoHE" name="tipoHE" class="form-control" required>
                        <option value="50%">50%</option>
                        <option value="100%">100%</option>
                    </select>
                </div>

                <div class="text-center">
                    <button type="submit" class="btn btn-primary px-4">Enviar</button>
                    <button type="reset" class="btn btn-secondary ml-2 px-4">Limpar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Preencher mês atual automaticamente
    const meses = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
    document.getElementById('mes').value = meses[new Date().getMonth()];

    // Buscar gerentes
    fetch('/planejamento-he/api/gerentes')
        .then(res => res.json())
        .then(data => {
            const select = document.getElementById('gerente');
            data.gerentes.forEach(g => {
                const opt = document.createElement('option');
                opt.value = g;
                opt.textContent = g;
                select.appendChild(opt);
            });
        });

    // Buscar colaboradores ao trocar gerente
    document.getElementById('gerente').addEventListener('change', e => {

        fetch(`/planejamento-he/api/colaboradores?gerente=${encodeURIComponent(e.target.value)}`)
            .then(res => res.json())
            .then(data => {
                const select = document.getElementById('colaborador');
                select.innerHTML = '<option value="">Selecione</option>';
                data.colaboradores.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c;
                    opt.textContent = c;
                    select.appendChild(opt);
                });
                // Ativar Select2 no campo colaborador
                $('#colaborador').select2({
                    placeholder: "Digite para buscar...",
                    width: '100%',
                    allowClear: true
                });
            });
    });
    // Buscar cargo e matrícula ao trocar colaborador
    $('#colaborador').on('change', function (e) {
        const nome = this.value;
        if (nome) {
            fetch(`/planejamento-he/api/cargo?nome=${encodeURIComponent(nome)}`)
                .then(res => res.json())
                .then(data => {
                    document.getElementById('cargo').value = data.cargo || '';
                    document.getElementById('matricula').value = data.matricula || '';
                });
        }
    });

    // Submeter formulário
    document.getElementById('formHE').addEventListener('submit', e => {
        e.preventDefault();
        const formData = {
            gerente: document.getElementById('gerente').value,
            colaborador: document.getElementById('colaborador').value,
            cargo: document.getElementById('cargo').value,
            matricula: document.getElementById('matricula').value,
            mes: document.getElementById('mes').value,
            horas: document.getElementById('horas').value,
            justificativa: document.getElementById('justificativa').value,
            tipoHE: document.getElementById('tipoHE').value
        };
        fetch('/planejamento-he/enviar', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData),
        })
            .then(res => res.json())
            .then(data => {
                alert(data.mensagem);
                if (data.sucesso) window.location.href = '/planejamento-he/envios';
            });
    });
</script>